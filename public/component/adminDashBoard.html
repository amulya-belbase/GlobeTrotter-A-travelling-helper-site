<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="../style.css">

</head>

<body>
    <div class="container">
        <nav>
            <div class="dashboard_logo">
                <a href="../index.html">
                    <img src="../assets/img/logo.png" alt="GlobeTrotter">
                </a>
            </div>
            <div class="dashboard_links">
                <a href="./adminHotels.html"><span>Add Hotels</span></a>
                <a href="./adminFlights.html"><span>Add Flights</span></a>
            </div>
        </nav>

        <div class="userEntries">
            <span>User <span class="dashboard_title">Hotels</span></span>
            <div class="userHotels">
                <!-- <div class="userHotelCard">
                    <p id="dashboard_hotel_name">Hotel Name</p>
                    <p id="dashboard_location_name">Location</p>
                    <p id="dashboard_contact_name">Contact</p>
                    <div id="dashboard_btn">
                        <button>Update</button>
                        <button id="dashboard_deleteBtn">Delete</button>
                    </div>
                </div> -->
            </div>
            <span>User <span class="dashboard_title">Flights</span></span>
            <div class="userFlights">
                <!-- <div class="userFlightCard">
                    <p id="dashboard_hotel_name">Hotel Name</p>
                    <p id="dashboard_location_name">Location</p>
                    <p id="dashboard_contact_name">Contact</p>
                    <div id="dashboard_btn">
                        <button>Update</button>
                        <button id="dashboard_deleteBtn">Delete</button>
                    </div>
                </div> -->
            </div>

        </div>

        <div id="hotelFormDiv">
            <form id="updateHotel">
                <div id="updateFormTop">
                    <span>Update Hotel Details</span>
                    <a href="" onclick="hideHotelPopUp()">X</a>
                </div>
                <label>Hotel Name: <input type="text" id="hotelname" name="hotelname"></label>
                <label>Location: <input type="text" id="location" name="location"></label>
                <label>Established: <input type="text" id="established" name="established"></label>
                <div class="room_div">
                    <label>Single Rooms: <input type="text" id="singleroom" name="singlerooms"></label>
                    <label>Single Room Rate: <input type="text" id="singleroomrate" name="singleroomrate"></label>
                </div>
                <div class="room_div">
                    <label>Double Rooms: <input type="text" id="doubleroom" name="doublerooms"></label>
                    <label>Double Room Rate: <input type="text" id="doubleroomrate" name="doubleroomrate"></label>
                </div>
                <div class="room_div">
                    <label>Suites: <input type="text" id="suite" name="suites"></label>
                    <label>Suite Rate: <input type="text" id="suiterate" name="suiterate"></label>
                </div>
                <label>Website: <input type="text" id="website" name="website"></label>
                <label>Email: <input type="email" id="email" name="email"></label>
                <label>Phone No: <input type="text" id="phoneno" name="phoneno"></label>
                <label>Image: <input type="file" id="image1" name="image1"></label>
                <button>Submit</button>
            </form>
        </div>
        
        <div id="flightFormDiv">
            <form id="updateFlight">
                <div id="updateFormTop">
                    <span>Update Flight Details</span>
                    <a href="" onclick="hideFlightPopUp()">X</a>
                </div>
                <label>Flight Name: <input type="text" id="flightname" name="flightname"></label>
                <div class="flight_div">
                    <label>Departure: <input type="text" id="flightdepart" name="flightdepart"></label>
                    <label>Destination: <input type="text" id="flightdest" name="flightdest"></label>
                </div>
                <div class="flight_div">
                    <label>Economy: <input type="number" id="economy" name="economy"></label>
                    <label>Economy Rate: <input type="number" id="economyrate" name="economyrate"></label>
                </div>
                <div class="flight_div">
                    <label>Business: <input type="number" id="business" name="business"></label>
                    <label>Business Rate: <input type="number" id="businessrate" name="businessrate"></label>
                </div>
                <label>Website: <input type="text" id="flightwebsite" name="website"></label>
                <label>Email: <input type="email" id="flightemail" name="email"></label>
                <label>Phone No: <input type="number" id="flightphoneno" name="phoneno"></label>
                <label>Image: <input type="file" id="flightimage1" name="image1"></label>
                <button>Submit</button>
            </form>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        function hideHotelPopUp() {
            const updateFormDiv = document.getElementById("hotelFormDiv");
            updateFormDiv.style.visibility = 'hidden';
        }
        function hideFlightPopUp() {
            const updateFormDiv = document.getElementById("flightFormDiv");
            updateFormDiv.style.visibility = 'hidden';
        }
        document.addEventListener('DOMContentLoaded', function () {
            const userId = localStorage.getItem('userId');
            const role = localStorage.getItem('role');


            // Make sure userId exists before sending the request
            if (userId && role === "admin") {

                // TO GET ALL THE USER CREATED HOTELS
                axios.get(`http://localhost:8000/hotels/getHotelsById/${userId}`)
                    .then(response => {
                        if (response.data.length === 0) {
                            console.log("this user doesn't have any data");
                        } else {
                            const divContainer = document.querySelector('.userHotels');
                            response.data.forEach(item => {

                                const cardContainer = document.createElement('div');
                                cardContainer.setAttribute('class', 'userHotelCard');

                                const itemElement1 = document.createElement('p');
                                itemElement1.setAttribute('id','dashboard_hotel_name');
                                const itemElement2 = document.createElement('p');
                                itemElement2.setAttribute('id','dashboard_location_name');
                                const itemElement3 = document.createElement('p');
                                itemElement3.setAttribute('id','dashboard_contact_name');

             
                                const btnContainer = document.createElement('div');
                                btnContainer.setAttribute('id', 'dashboard_btn');
                                const updateBtn = document.createElement('button');
                                const deleteBtn = document.createElement('button');

                                // Set the hotelId as a data attribute for each button
                                updateBtn.setAttribute('updateBtn', item.id);
                                deleteBtn.setAttribute('deleteBtn', item.id);
                                deleteBtn.setAttribute('id', 'dashboard_deleteBtn');


                                itemElement1.textContent = `Hotel Name: ${item.hotelname}`;
                                itemElement2.textContent = `Location: ${item.location}`;
                                itemElement3.textContent = `Contact: ${item.phoneno}`;

                                updateBtn.textContent = 'Update';
                                deleteBtn.textContent = 'Delete';
                                btnContainer.appendChild(updateBtn);
                                btnContainer.appendChild(deleteBtn);

                                cardContainer.appendChild(itemElement1);
                                cardContainer.appendChild(itemElement2);
                                cardContainer.appendChild(itemElement3);
                                cardContainer.appendChild(btnContainer);


                                divContainer.appendChild(cardContainer);

                                // Event listener for the update button
                                updateBtn.addEventListener('click', function () {

                                    const hotelId = Number(this.getAttribute('updateBtn'));
                                    console.log('Update clicked for hotelId:', hotelId);

                                    const updateFormDiv = document.getElementById("hotelFormDiv");
                                    const updateForm = document.getElementById("updateHotel");
                                    updateFormDiv.style.visibility = 'visible';
                                    updateForm.style.opacity = "1";

                                    try {
                                        const selectedItem = response.data.find(item => item.id === hotelId);
                                        document.getElementById('hotelname').value = selectedItem.hotelname;
                                        document.getElementById('location').value = selectedItem.location;
                                        document.getElementById('established').value = selectedItem.established;
                                        document.getElementById('singleroom').value = selectedItem.singlerooms;
                                        document.getElementById('singleroomrate').value = selectedItem.singleroomrate;
                                        document.getElementById('doubleroom').value = selectedItem.doublerooms;
                                        document.getElementById('doubleroomrate').value = selectedItem.doubleroomrate;
                                        document.getElementById('suite').value = selectedItem.suites;
                                        document.getElementById('suiterate').value = selectedItem.suiterate;
                                        document.getElementById('website').value = selectedItem.website;
                                        document.getElementById('email').value = selectedItem.email;
                                        document.getElementById('phoneno').value = selectedItem.phoneno;

                                        updateForm.addEventListener('submit', function (event) {
                                            event.preventDefault(); // Prevent default form submission

                                            // Get form data
                                            const hotelname = document.getElementById('hotelname').value;
                                            const location = document.getElementById('location').value;
                                            const established = document.getElementById('established').value;
                                            const singleroom = document.getElementById('singleroom').value;
                                            const singleroomrate = document.getElementById('singleroomrate').value;
                                            const doubleroom = document.getElementById('doubleroom').value;
                                            const doubleroomrate = document.getElementById('doubleroomrate').value;
                                            const suite = document.getElementById('suite').value;
                                            const suiterate = document.getElementById('suiterate').value;
                                            const website = document.getElementById('website').value;
                                            const email = document.getElementById('email').value;
                                            const phoneno = document.getElementById('phoneno').value;
                                            const image1 = document.getElementById('image1').value;

                                            // FORM VALIDATION IS NEEDED
                                            const updatedHotelData = {
                                                userId: localStorage.getItem('userId'),
                                                hotelname: hotelname,
                                                location: location,
                                                established: established,
                                                singleroom: singleroom,
                                                singleroomrate: singleroomrate,
                                                doubleroom: doubleroom,
                                                doubleroomrate: doubleroomrate,
                                                suite: suite,
                                                suiterate: suiterate,
                                                website: website,
                                                email: email,
                                                phoneno: phoneno,
                                                image1: image1,
                                                createdat: selectedItem.createdat,
                                            };

                                            // console.log(formData);

                                            // Send form data using Axios
                                            axios.put(`http://localhost:8000/hotels/update/${hotelId}`, updatedHotelData)
                                                .then(response => {

                                                    if (response.status === 200) {
                                                        updateFormDiv.style.visibility = 'hidden';
                                                        updateForm.style.opacity = '0';
                                                        alert("Hotel updated successfully");
                                                        window.location.href = './adminDashBoard.html';
                                                    }
                                                })
                                                .catch(error => {
                                                    console.error('Error updating hotel:', error);
                                                    // Handle error while trying to update the hotel
                                                    if (error.response.status === 401) {
                                                        alert("Unauthorized request");
                                                    }
                                                });
                                        });
                                    } catch (error) {
                                        updateFormDiv.style.visibility = 'hidden';
                                        updateForm.style.opacity = '0';
                                        alert("Unauthorized request");
                                        window.location.href = './adminDashBoard.html';
                                    }


                                });

                                // Event listener for the delete button
                                deleteBtn.addEventListener('click', function () {
                                    const hotelId = Number(this.getAttribute('deleteBtn'));
                                    const userId = localStorage.getItem('userId');
                                    const hotelIds = [hotelId, userId]; 
                                    const concatenatedIds = hotelIds.join(',');
                                    axios.delete(`http://localhost:8000/hotels/delete/${concatenatedIds}`)
                                        .then(response => {

                                            if (response.status === 200) {
                                                alert('Hotel entry deleted successfully');
                                            }
                                            console.log(`Hotel with ID ${hotelId} deleted successfully`);
                                            // this.parentNode.remove(); 

                                            window.location.href = './adminDashBoard.html';
                                        })
                                        .catch(error => {
                                            console.error('Error deleting hotel:', error);
                                            if (error.response.status === 401) {
                                                alert("Unauthorized request");
                                                window.location.href = './adminDashBoard.html';
                                            }
                                        });
                                });
                            });
                        }
                    })
                    .catch(error => {
                        console.log(error);
                    });


                // TO GET ALL THE USER CREATED FLIGHTS
                axios.get(`http://localhost:8000/flights/getFlightsById/${userId}`)
                    .then(response => {
                        if (response.data.length === 0) {
                            // console.log("this user doesn't have any data");
                        } else {
                            const divContainer = document.querySelector('.userFlights');
                            response.data.forEach(item => {

                                const cardContainer = document.createElement('div');
                                cardContainer.setAttribute('class', 'userFlightCard');

                                const itemElement1 = document.createElement('p');
                                itemElement1.setAttribute('id', 'dashboard_hotel_name');

                                const itemElement2 = document.createElement('p');
                                itemElement2.setAttribute('id', 'dashboard_location_name');
                                
                                const itemElement3 = document.createElement('p');
                                itemElement3.setAttribute('id', 'dashboard_location_name');

                                const itemElement4 = document.createElement('p');
                                itemElement4.setAttribute('id', 'dashboard_contact_name');

                                const btnContainer = document.createElement('div');
                                btnContainer.setAttribute('id', 'dashboard_btn');
                                const updateBtn = document.createElement('button');
                                const deleteBtn = document.createElement('button');
                                
                                // Set the hotelId as a data attribute for each button
                                updateBtn.setAttribute('updateBtn', item.id);
                                deleteBtn.setAttribute('deleteBtn', item.id);
                                deleteBtn.setAttribute('id','dashboard_deleteBtn');

                                itemElement1.textContent = `Flight Name: ${item.flightname}`;
                                itemElement2.textContent = `Departure: ${item.flightdepart}`;
                                itemElement3.textContent = `Destination: ${item.flightdest}`;
                                itemElement4.textContent = `Contact: ${item.phoneno}`;

                                updateBtn.textContent = 'Update';
                                deleteBtn.textContent = 'Delete';
                                btnContainer.appendChild(updateBtn);
                                btnContainer.appendChild(deleteBtn);

                                cardContainer.appendChild(itemElement1);
                                cardContainer.appendChild(itemElement2);
                                cardContainer.appendChild(itemElement3);
                                cardContainer.appendChild(itemElement4);
                                cardContainer.appendChild(btnContainer);

                                divContainer.appendChild(cardContainer);

                                // Event listener for the update button
                                updateBtn.addEventListener('click', function () {

                                    const flightId = Number(this.getAttribute('updateBtn'));
                                    console.log('Update clicked for flightId:', flightId);

                                    const updateFormDiv = document.getElementById("flightFormDiv");
                                    const updateForm = document.getElementById("updateFlight");
                                    updateFormDiv.style.visibility = 'visible';
                                    updateForm.style.opacity = "1";

                                    try{
                                        const selectedItem = response.data.find(item => item.id === flightId);
                                        document.getElementById('flightname').value = selectedItem.flightname
                                        document.getElementById('flightdepart').value = selectedItem.flightdepart
                                        document.getElementById('flightdest').value = selectedItem.flightdest
                                        document.getElementById('economy').value = selectedItem.economy
                                        document.getElementById('economyrate').value = selectedItem.economyrate
                                        document.getElementById('business').value = selectedItem.business
                                        document.getElementById('businessrate').value = selectedItem.businessrate
                                        document.getElementById('flightwebsite').value = selectedItem.website
                                        document.getElementById('flightemail').value = selectedItem.email
                                        document.getElementById('flightphoneno').value = selectedItem.phoneno
    
    
                                        updateForm.addEventListener('submit', function (event) {
                                            event.preventDefault(); // Prevent default form submission
    
                                            // Get form data
                                            const flightname = document.getElementById('flightname').value;
                                            const flightdepart = document.getElementById('flightdepart').value;
                                            const flightdest = document.getElementById('flightdest').value;
                                            const economy = document.getElementById('economy').value;
                                            const economyrate = document.getElementById('economyrate').value;
                                            const business = document.getElementById('business').value;
                                            const businessrate = document.getElementById('businessrate').value;
                                            const website = document.getElementById('flightwebsite').value;
                                            const email = document.getElementById('flightemail').value;
                                            const phoneno = document.getElementById('flightphoneno').value;
                                            const image1 = document.getElementById('flightimage1').value;
    
                                            // FORM VALIDATION IS NEEDED
                                            const updatedFlightData = {
                                                userId: localStorage.getItem('userId'),
                                                flightname: flightname,
                                                flightdepart: flightdepart,
                                                flightdest: flightdest,
                                                economy: economy,
                                                economyrate: economyrate,
                                                business: business,
                                                businessrate: businessrate,
                                                website: website,
                                                email: email,
                                                phoneno: phoneno,
                                                image1: image1,
                                                createdat: selectedItem.createdat,
                                            };
    
                                            // console.log(formData);
    
                                            // Send form data using Axios
                                            axios.put(`http://localhost:8000/flights/update/${flightId}`, updatedFlightData)
                                                .then(response => {
    
                                                    if (response.status === 200) {
                                                        updateFormDiv.style.visibility = 'hidden';
                                                        updateForm.style.opacity = '0';
                                                        alert("Flight updated successfully");
                                                        window.location.href = './adminDashBoard.html';
                                                    }
                                                })
                                                .catch(error => {
                                                    console.error('Error updating flight:', error);
                                                    // Handle error while trying to update the hotel
                                                });
                                        });

                                    }catch(error){
                                        updateFormDiv.style.visibility = 'hidden';
                                        updateForm.style.opacity = '0';
                                        alert("Unauthorized request");
                                        window.location.href = './adminDashBoard.html';
                                    }
                                });

                                // Event listener for the delete button
                                deleteBtn.addEventListener('click', function () {
                                    const flightId = Number(this.getAttribute('deleteBtn'));
                                    const userId = localStorage.getItem('userId');
                                    const flightIds = [flightId, userId]; 
                                    const concatenatedIds = flightIds.join(',');
                                    axios.delete(`http://localhost:8000/flights/delete/${concatenatedIds}`)
                                        .then(response => {

                                            if (response.status === 200) {
                                                alert('Flight entry deleted successfully');
                                            }
                                            console.log(`Flight with ID ${flightId} deleted successfully`);
                                            // this.parentNode.remove(); 

                                            window.location.href = './adminDashBoard.html';
                                        })
                                        .catch(error => {
                                            console.error('Error deleting flight:', error);
                                            if (error.response.status === 401) {
                                                alert("Unauthorized request");
                                                window.location.href = './adminDashBoard.html';
                                            }
                                        });
                                });
                            });
                        }
                    })
                    .catch(error => {
                        console.log(error);
                    });

            } else {
                window.location.href = './login.html';
            }
        });


    </script>


</body>

</html>